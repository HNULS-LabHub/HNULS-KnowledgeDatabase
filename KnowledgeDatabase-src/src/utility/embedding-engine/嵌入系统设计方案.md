# åµŒå…¥ç³»ç»Ÿå®Œæ•´è®¾è®¡æ–¹æ¡ˆ (Embedding Engine Design)

> **åˆ›å»ºæ—¶é—´**: 2026-01-26  
> **ç‰ˆæœ¬**: v1.0  
> **ç›®æ ‡**: åŸºäºé¡¹ç›®ç°çŠ¶,è®¾è®¡é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€æˆæœ¬ä¼˜åŒ–çš„å‘é‡åµŒå…¥ç³»ç»Ÿ

---

## ğŸ“Š ä¸€ã€ç³»ç»Ÿå®šä½ä¸æ ¸å¿ƒéœ€æ±‚

### 1.1 ç³»ç»Ÿç‰¹æ€§
- **ç½‘ç»œ I/O å¯†é›†å‹**: ä¸»è¦ç“¶é¢ˆåœ¨ HTTP è¯·æ±‚,è€Œé CPU è®¡ç®—
- **ç‹¬ç«‹è¿›ç¨‹è¿è¡Œ**: Utility Process,ç»ä¸é˜»å¡ä¸»è¿›ç¨‹å’Œ UI
- **é«˜ååè®¾è®¡**: é€šè¿‡å¹¶å‘æ§åˆ¶å‹æ¦¨ç½‘ç»œå¸¦å®½,è¾¾åˆ°æœåŠ¡å•† RPM ä¸Šé™

### 1.2 æ ¸å¿ƒèŒè´£

#### âœ… å·²æ˜ç¡®çš„èŒè´£
1. **ç»´æŠ¤åˆ†å±‚ä»»åŠ¡è¡¨**: æ–‡æ¡£ â†’ Chunks çš„ä¸¤çº§ç»“æ„
2. **æŒ‰åºæäº¤ Chunks**: è°ƒç”¨ OpenAI SDK è¿›è¡Œéæµå¼åµŒå…¥
3. **è¿›åº¦è®¡ç®—ä¸å›è°ƒ**: `å·²å®Œæˆ Chunks / æ€» Chunks` â†’ é€šçŸ¥å…¨å±€ç›‘æ§
4. **å¤šæºè½®è¯¢ä¸åˆ‡æ¢**: åŒä¸€æ¨¡å‹çš„å¤šä¸ª Channel,æŒ‰ä¼˜å…ˆçº§çº§è”

#### ğŸ¯ éœ€è¦è®¾è®¡çš„éƒ¨åˆ†
- ä»»åŠ¡è¡¨çš„å…·ä½“æ•°æ®ç»“æ„
- Chunk æäº¤çš„è°ƒåº¦ç®—æ³•
- ä¸ TaskRegistry çš„é›†æˆæ–¹å¼
- Channel é…ç½®ä¸åˆ‡æ¢é€»è¾‘
- é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥

---

## ğŸ—ï¸ äºŒã€æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿåˆ†å±‚

```mermaid
graph TB
    subgraph "Main Process ä¸»è¿›ç¨‹"
        IPCHandler["Embedding IPC Handler<br/>è½¬å‘æŒ‡ä»¤"]
        ModelConfig["ModelConfigService<br/>æä¾›å•†é…ç½®"]
    end
    
    subgraph "Utility Process: Embedding Engine åµŒå…¥å¼•æ“"
        EntryPoint["entry.ts<br/>è¿›ç¨‹å…¥å£"]
        
        subgraph "æ ¸å¿ƒå±‚"
            TaskManager["TaskManager ä»»åŠ¡ç®¡ç†å™¨<br/>æ–‡æ¡£â†’Chunks ä¸¤çº§è¡¨"]
            Scheduler["Scheduler è°ƒåº¦å™¨<br/>å¹¶å‘æ§åˆ¶ + é˜Ÿåˆ—"]
        end
        
        subgraph "æ‰§è¡Œå±‚"
            ChannelManager["ChannelManager é€šé“ç®¡ç†å™¨<br/>å¤šæºçº§è” + ç†”æ–­"]
            OpenAIClient["OpenAI Client<br/>SDK å°è£…"]
        end
        
        subgraph "ç›‘æ§å±‚"
            ProgressTracker["ProgressTracker è¿›åº¦è¿½è¸ª<br/>è®¡ç®—å®Œæˆç‡"]
            TaskMonitorBridge["TaskMonitor Bridge<br/>å›è°ƒå…¨å±€ç›‘æ§"]
        end
    end
    
    subgraph "Global Monitor å…¨å±€ç›‘æ§"
        TaskRegistry["TaskRegistry<br/>ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†"]
    end
    
    IPCHandler -->|IPC: start-embed| EntryPoint
    ModelConfig -->|æä¾› Channel é…ç½®| ChannelManager
    
    EntryPoint --> TaskManager
    TaskManager --> Scheduler
    Scheduler --> ChannelManager
    ChannelManager --> OpenAIClient
    
    Scheduler --> ProgressTracker
    ProgressTracker --> TaskMonitorBridge
    TaskMonitorBridge -->|IPC: update-progress| TaskRegistry
    
    style TaskManager fill:#ffe1e1
    style Scheduler fill:#e1ffe1
    style ChannelManager fill:#ffeb99
```

### 2.2 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ | æ ¸å¿ƒæ–¹æ³• |
|------|------|------|----------|
| **TaskManager** | `task-manager.ts` | ç»´æŠ¤æ–‡æ¡£å’Œ Chunks çš„ä¸¤çº§æ˜ å°„å…³ç³» | `createDocumentTask()`, `addChunks()`, `getNextChunk()` |
| **Scheduler** | `scheduler.ts` | å¹¶å‘æ§åˆ¶ + é˜Ÿåˆ—è°ƒåº¦ | `setConcurrency()`, `submitChunk()`, `_processQueue()` |
| **ChannelManager** | `channel-manager.ts` | å¤šæºè½®è¯¢ + è‡ªåŠ¨é™çº§ | `embedWithFallback()`, `markChannelFailed()` |
| **OpenAIClient** | `openai-client.ts` | OpenAI SDK å°è£… | `createEmbedding()` |
| **ProgressTracker** | `progress-tracker.ts` | è¿›åº¦è®¡ç®— | `updateChunkCompleted()`, `getDocumentProgress()` |

---

## ğŸ—‚ï¸ ä¸‰ã€æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡

### 3.1 ä¸¤çº§ä»»åŠ¡è¡¨ (TaskManager)

```typescript
/**
 * æ–‡æ¡£çº§ä»»åŠ¡ (Document Task)
 */
interface DocumentTask {
  documentId: string           // æ–‡æ¡£å”¯ä¸€æ ‡è¯† (ä¾‹å¦‚: fileKey æˆ– hash)
  totalChunks: number          // æ€» chunk æ•°
  completedChunks: number      // å·²å®Œæˆæ•°
  failedChunks: number         // å¤±è´¥æ•°
  status: 'pending' | 'running' | 'completed' | 'failed'
  createdAt: number
  updatedAt: number
  
  // å¯é€‰å…ƒæ•°æ®
  meta?: {
    fileName?: string
    knowledgeBaseId?: string
  }
}

/**
 * Chunk çº§ä»»åŠ¡
 */
interface ChunkTask {
  chunkId: string              // chunk å”¯ä¸€æ ‡è¯† (documentId + index)
  documentId: string           // æ‰€å±æ–‡æ¡£
  index: number                // åœ¨æ–‡æ¡£ä¸­çš„åºå· (ç”¨äºæ’åº)
  text: string                 // å¾…åµŒå…¥çš„æ–‡æœ¬
  status: 'pending' | 'running' | 'completed' | 'failed' | 'retrying'
  retryCount: number           // é‡è¯•æ¬¡æ•°
  embedding?: number[]         // ç”Ÿæˆçš„å‘é‡ (å®Œæˆåå¡«å……)
  error?: string               // é”™è¯¯ä¿¡æ¯
  createdAt: number
  updatedAt: number
}
```

**å­˜å‚¨æ–¹å¼**:
```typescript
class TaskManager {
  private documentTasks: Map<string, DocumentTask> = new Map()
  private chunkTasks: Map<string, ChunkTask> = new Map()
  
  // ç´¢å¼•: å¿«é€ŸæŸ¥è¯¢æŸæ–‡æ¡£çš„æ‰€æœ‰ chunks
  private documentChunksIndex: Map<string, Set<string>> = new Map()
}
```

### 3.2 é€šé“é…ç½® (Channel Config)

```typescript
/**
 * å•ä¸ªé€šé“é…ç½®
 * æ³¨æ„: ä¸€ä¸ªæ¨¡å‹å¯ä»¥æœ‰å¤šä¸ªé€šé“
 */
interface ChannelConfig {
  id: string                   // channel-xxx
  providerId: string           // å¯¹åº” ModelConfigService çš„ providerId
  priority: number             // ä¼˜å…ˆçº§ (0æœ€é«˜, æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šä½)
  baseUrl: string              // API åŸºåœ°å€
  apiKey: string               // API å¯†é’¥
  model: string                // æ¨¡å‹åç§° (e.g. text-embedding-3-large)
  
  // çŠ¶æ€ç®¡ç†
  status: 'active' | 'degraded' | 'blacklisted'
  failureCount: number         // è¿ç»­å¤±è´¥æ¬¡æ•°
  lastFailedAt?: number        // æœ€åå¤±è´¥æ—¶é—´
  blacklistedUntil?: number    // é»‘åå•è§£é™¤æ—¶é—´
  
  // æ€§èƒ½å‚æ•°
  maxRetries: number           // å•æ¬¡è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•° (é’ˆå¯¹å•ä¸ª channel)
  timeout: number              // è¯·æ±‚è¶…æ—¶æ—¶é—´ (ms)
}
```

**é…ç½®æ¥æº**:
- ä» `ModelConfigService` è¯»å– `providers`
- ç”¨æˆ·å¯ä¸ºåŒä¸€æ¨¡å‹é…ç½®å¤šä¸ª provider,æ¯ä¸ª provider å¯¹åº”ä¸€ä¸ª channel
- åµŒå…¥å¼•æ“å†…éƒ¨æŒ‰ `priority` æ’åº

### 3.3 ä»»åŠ¡æäº¤å‚æ•° (Submit Params)

```typescript
/**
 * å‰ç«¯æäº¤åµŒå…¥ä»»åŠ¡çš„å‚æ•°
 */
interface SubmitEmbeddingTaskParams {
  documentId: string           // æ–‡æ¡£ ID
  chunks: Array<{
    index: number              // chunk åœ¨æ–‡æ¡£ä¸­çš„é¡ºåº
    text: string               // chunk æ–‡æœ¬
  }>
  
  // åµŒå…¥é…ç½®
  embeddingConfig: {
    modelId: string            // æ¨¡å‹ ID (e.g. text-embedding-3-large)
    dimensions?: number        // å¯é€‰: å‘é‡ç»´åº¦
  }
  
  // å¯é€‰å…ƒæ•°æ®
  meta?: {
    fileName?: string
    knowledgeBaseId?: string
  }
}
```

---

## âš™ï¸ å››ã€æ ¸å¿ƒæµç¨‹è®¾è®¡

### 4.1 ä»»åŠ¡æäº¤æµç¨‹

```mermaid
sequenceDiagram
    participant Renderer as æ¸²æŸ“è¿›ç¨‹<br/>(Vue UI)
    participant Main as ä¸»è¿›ç¨‹<br/>(IPC Handler)
    participant Embed as åµŒå…¥å¼•æ“<br/>(Utility Process)
    participant TaskMon as å…¨å±€ç›‘æ§<br/>(Global Monitor)
    
    Renderer->>Main: æäº¤åµŒå…¥ä»»åŠ¡<br/>window.api.embedding.submit(params)
    Main->>TaskMon: åˆ›å»ºæ–‡æ¡£çº§ä»»åŠ¡<br/>taskMonitor.createTask()
    TaskMon-->>Main: è¿”å› taskHandle
    Main->>Embed: MessagePort è½¬å‘ä»»åŠ¡<br/>{ type: 'embed:start', data: {...} }
    
    Embed->>Embed: TaskManager.createDocumentTask()
    Embed->>Embed: TaskManager.addChunks(chunks)
    Embed->>Embed: Scheduler.enqueue(chunks)
    
    Main-->>Renderer: è¿”å› taskId
    
    loop å¹¶å‘å¤„ç†
        Embed->>Embed: Scheduler å–å‡º chunk
        Embed->>Embed: ChannelManager.embedWithFallback()
        Embed->>Embed: ProgressTracker.updateChunkCompleted()
        Embed->>TaskMon: å›è°ƒè¿›åº¦<br/>{ taskId, progress, meta }
        TaskMon-->>Renderer: å‰ç«¯ç›‘å¬è¿›åº¦æ›´æ–°
    end
    
    Embed->>TaskMon: ä»»åŠ¡å®Œæˆ<br/>taskHandle.complete()
```

### 4.2 Chunk è°ƒåº¦ç®—æ³• (Scheduler)

#### æ ¸å¿ƒè®¾è®¡æ€è·¯
- **å¹¶å‘æ±  (Concurrency Pool)**: ç”¨ä¿¡å·é‡ (Semaphore) æ§åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°
- **FIFO é˜Ÿåˆ—**: æŒ‰ documentId + index é¡ºåºæäº¤ (ä¿è¯åŒä¸€æ–‡æ¡£å†… chunks æŒ‰åºå¤„ç†)
- **åŠ¨æ€è°ƒèŠ‚**: å…è®¸è¿è¡Œæ—¶ä¿®æ”¹ `maxConcurrency`

#### ä¼ªä»£ç 
```typescript
class Scheduler {
  private queue: ChunkTask[] = []
  private running: Set<string> = new Set()
  private maxConcurrency: number = 3 // é»˜è®¤å¹¶å‘æ•°
  
  async enqueue(chunks: ChunkTask[]): Promise<void> {
    this.queue.push(...chunks)
    this._tryProcess()
  }
  
  setConcurrency(value: number): void {
    this.maxConcurrency = value
    this._tryProcess() // ç«‹å³ç”Ÿæ•ˆ
  }
  
  private async _tryProcess(): Promise<void> {
    while (this.running.size < this.maxConcurrency && this.queue.length > 0) {
      const chunk = this.queue.shift()!
      this.running.add(chunk.chunkId)
      
      // å¼‚æ­¥å¤„ç† chunk
      this._processChunk(chunk).finally(() => {
        this.running.delete(chunk.chunkId)
        this._tryProcess() // é€’å½’è°ƒç”¨,å¤„ç†ä¸‹ä¸€ä¸ª
      })
    }
  }
  
  private async _processChunk(chunk: ChunkTask): Promise<void> {
    try {
      const embedding = await this.channelManager.embedWithFallback(chunk.text)
      this.taskManager.markChunkCompleted(chunk.chunkId, embedding)
      this.progressTracker.updateChunkCompleted(chunk.documentId)
    } catch (err) {
      this.taskManager.markChunkFailed(chunk.chunkId, err.message)
    }
  }
}
```

### 4.3 å¤šé€šé“çº§è” (Channel Cascading)

#### çº§è”ç­–ç•¥
1. **æŒ‰ä¼˜å…ˆçº§æ’åº**: `priority: 0, 1, 2, ...`
2. **é€çº§å°è¯•**: ä» priority=0 å¼€å§‹,å¤±è´¥åå°è¯•ä¸‹ä¸€çº§
3. **ç†”æ–­æœºåˆ¶**: è¿ç»­å¤±è´¥ N æ¬¡çš„ channel è¿›å…¥é»‘åå• (cooldown 5åˆ†é’Ÿ)

#### ä¼ªä»£ç 
```typescript
class ChannelManager {
  private channels: ChannelConfig[] = []
  
  async embedWithFallback(text: string): Promise<number[]> {
    // æ’åº: priority å‡åº, è¿‡æ»¤é»‘åå•
    const activeChannels = this.channels
      .filter(ch => ch.status !== 'blacklisted' || Date.now() > ch.blacklistedUntil!)
      .sort((a, b) => a.priority - b.priority)
    
    let lastError: Error | null = null
    
    for (const channel of activeChannels) {
      try {
        const embedding = await this.openaiClient.createEmbedding({
          baseUrl: channel.baseUrl,
          apiKey: channel.apiKey,
          model: channel.model,
          input: text
        })
        
        // æˆåŠŸ: é‡ç½®å¤±è´¥è®¡æ•°
        channel.failureCount = 0
        channel.status = 'active'
        return embedding
        
      } catch (err) {
        lastError = err
        this.markChannelFailed(channel.id, err.code)
        
        // ç‰¹å®šé”™è¯¯ä¸é‡è¯•ä¸‹ä¸€ä¸ª (å¦‚: 400 Bad Request)
        if (err.code === 400) {
          throw err
        }
        
        // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª channel
        continue
      }
    }
    
    // æ‰€æœ‰ channel éƒ½å¤±è´¥
    throw lastError || new Error('No active channels available')
  }
  
  private markChannelFailed(channelId: string, errorCode?: number): void {
    const channel = this.channels.find(ch => ch.id === channelId)
    if (!channel) return
    
    channel.failureCount++
    channel.lastFailedAt = Date.now()
    
    // ç†”æ–­: è¿ç»­å¤±è´¥ 5 æ¬¡ â†’ é»‘åå• 5 åˆ†é’Ÿ
    if (channel.failureCount >= 5) {
      channel.status = 'blacklisted'
      channel.blacklistedUntil = Date.now() + 5 * 60 * 1000
      
      // 5 åˆ†é’Ÿåè‡ªåŠ¨è§£é™¤é»‘åå•
      setTimeout(() => {
        channel.status = 'active'
        channel.failureCount = 0
      }, 5 * 60 * 1000)
    }
  }
}
```

### 4.4 è¿›åº¦è®¡ç®—ä¸å›è°ƒ

#### è®¡ç®—å…¬å¼
```
æ–‡æ¡£è¿›åº¦ = (completedChunks / totalChunks) * 100
```

#### å›è°ƒæ—¶æœº
- æ¯å®Œæˆä¸€ä¸ª chunk,ç«‹å³å›è°ƒ (`updateChunkCompleted()`)
- å›è°ƒå†…å®¹åŒ…æ‹¬:
  - `taskId`: å…¨å±€ç›‘æ§çš„ä»»åŠ¡ ID
  - `progress`: å½“å‰è¿›åº¦ç™¾åˆ†æ¯”
  - `meta`: é¢å¤–ä¿¡æ¯ (å¦‚: `completedChunks`, `totalChunks`, `currentRPM`)

#### ä¼ªä»£ç 
```typescript
class ProgressTracker {
  async updateChunkCompleted(documentId: string): Promise<void> {
    const docTask = this.taskManager.getDocumentTask(documentId)
    if (!docTask) return
    
    docTask.completedChunks++
    docTask.updatedAt = Date.now()
    
    const progress = (docTask.completedChunks / docTask.totalChunks) * 100
    
    // å›è°ƒå…¨å±€ç›‘æ§
    await this.taskMonitorBridge.updateProgress(docTask.taskId, progress, {
      completedChunks: docTask.completedChunks,
      totalChunks: docTask.totalChunks,
      documentId: documentId
    })
    
    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if (docTask.completedChunks === docTask.totalChunks) {
      await this.taskMonitorBridge.complete(docTask.taskId)
    }
  }
}
```

---

## ğŸ“¡ äº”ã€IPC é€šä¿¡åè®®è®¾è®¡

### 5.1 æ¶ˆæ¯ç±»å‹å®šä¹‰

```typescript
/**
 * Main Process â†’ Embedding Engine
 */
type EmbeddingEngineInboundMessage =
  | { type: 'embed:start'; data: SubmitEmbeddingTaskParams }
  | { type: 'embed:pause'; data: { documentId: string } }
  | { type: 'embed:resume'; data: { documentId: string } }
  | { type: 'embed:cancel'; data: { documentId: string } }
  | { type: 'config:update-channels'; data: { channels: ChannelConfig[] } }
  | { type: 'config:set-concurrency'; data: { concurrency: number } }

/**
 * Embedding Engine â†’ Main Process
 */
type EmbeddingEngineOutboundMessage =
  | { type: 'task:progress'; data: { documentId: string; progress: number; meta: any } }
  | { type: 'task:completed'; data: { documentId: string; embeddings: Map<number, number[]> } }
  | { type: 'task:failed'; data: { documentId: string; error: string } }
  | { type: 'channel:failed'; data: { channelId: string; error: string } }
  | { type: 'metrics:rpm-update'; data: { currentRPM: number } }
```

### 5.2 IPC Handler (ä¸»è¿›ç¨‹ç«¯)

```typescript
// src/main/ipc/embedding-handler.ts
export class EmbeddingIPCHandler {
  constructor(
    private embeddingEnginePort: MessagePort,
    private taskMonitorService: TaskMonitorService
  ) {
    this.setupListeners()
  }
  
  async submitEmbeddingTask(params: SubmitEmbeddingTaskParams): Promise<string> {
    // 1. åˆ›å»ºå…¨å±€ç›‘æ§ä»»åŠ¡
    const taskHandle = await this.taskMonitorService.createTask({
      type: 'embedding',
      title: `åµŒå…¥: ${params.meta?.fileName || params.documentId}`,
      meta: {
        documentId: params.documentId,
        totalChunks: params.chunks.length
      }
    })
    
    // 2. è½¬å‘ç»™ Embedding Engine
    this.embeddingEnginePort.postMessage({
      type: 'embed:start',
      data: {
        ...params,
        taskId: taskHandle.taskId // å…³è”å…¨å±€ç›‘æ§ ID
      }
    })
    
    return taskHandle.taskId
  }
  
  private setupListeners(): void {
    this.embeddingEnginePort.on('message', (msg: EmbeddingEngineOutboundMessage) => {
      switch (msg.type) {
        case 'task:progress':
          // è½¬å‘è¿›åº¦ç»™å…¨å±€ç›‘æ§
          // (Embedding Engine å†…éƒ¨å·²ç»é€šè¿‡ TaskMonitorBridge å›è°ƒ)
          break
          
        case 'task:completed':
          // å¯ä»¥åœ¨è¿™é‡ŒæŒä¹…åŒ–åµŒå…¥ç»“æœåˆ° SurrealDB/VectorDB
          this.saveEmbeddings(msg.data.documentId, msg.data.embeddings)
          break
          
        case 'channel:failed':
          // è®°å½•æ—¥å¿—æˆ–å‘Šè­¦
          console.warn(`Channel ${msg.data.channelId} failed:`, msg.data.error)
          break
      }
    })
  }
}
```

---

## ğŸ› ï¸ å…­ã€é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥

### 6.1 é”™è¯¯åˆ†ç±»

| é”™è¯¯ç±»å‹ | HTTP çŠ¶æ€ç  | å¤„ç†ç­–ç•¥ |
|---------|------------|---------|
| **å®¢æˆ·ç«¯é”™è¯¯** | 400, 401, 403 | ä¸é‡è¯•,ç«‹å³å¤±è´¥ |
| **é€Ÿç‡é™åˆ¶** | 429 | åˆ‡æ¢ä¸‹ä¸€ä¸ª channel |
| **æœåŠ¡ç«¯é”™è¯¯** | 500, 502, 503 | åˆ‡æ¢ä¸‹ä¸€ä¸ª channel |
| **è¶…æ—¶** | Timeout | åˆ‡æ¢ä¸‹ä¸€ä¸ª channel |
| **ç½‘ç»œé”™è¯¯** | ECONNRESET, ETIMEDOUT | åˆ‡æ¢ä¸‹ä¸€ä¸ª channel |

### 6.2 é‡è¯•é€»è¾‘

- **å• Channel é‡è¯•**: ä¸è¿›è¡Œ,ç›´æ¥åˆ‡æ¢ä¸‹ä¸€ä¸ª channel (é¿å…æµªè´¹æ—¶é—´)
- **çº§è”é‡è¯•**: éå†æ‰€æœ‰ channels,å…¨éƒ¨å¤±è´¥åæ‰æ ‡è®°ä»»åŠ¡å¤±è´¥
- **ä»»åŠ¡çº§é‡è¯•**: ç”¨æˆ·å¯æ‰‹åŠ¨é‡è¯•å¤±è´¥çš„æ–‡æ¡£

---

## ğŸ›ï¸ ä¸ƒã€ç”¨æˆ·é…ç½®ä¸ç›‘æ§

### 7.1 é…ç½®é¢æ¿è®¾è®¡ (UI)

**ä½ç½®**: `UserSettingView.vue` â†’ `EmbeddingConfigView.vue`

**é…ç½®é¡¹**:
1. **å¹¶å‘æ•°è®¾ç½®** (æ»‘å— 1-50)
   - é»˜è®¤å€¼: 3
   - è¯´æ˜: åŒæ—¶è¿›è¡Œçš„ HTTP è¯·æ±‚æ•°
   
2. **Channel é…ç½®** (åˆ—è¡¨)
   - æ˜¾ç¤ºæ‰€æœ‰ providers
   - å…è®¸è®¾ç½®æ¯ä¸ª provider çš„ä¼˜å…ˆçº§ (æ‹–æ‹½æ’åº)
   - æ˜¾ç¤º Channel çŠ¶æ€ (active / degraded / blacklisted)

3. **ç†”æ–­å‚æ•°** (é«˜çº§)
   - è¿ç»­å¤±è´¥æ¬¡æ•°é˜ˆå€¼ (é»˜è®¤ 5)
   - é»‘åå•æ—¶é•¿ (é»˜è®¤ 5 åˆ†é’Ÿ)

### 7.2 ç›‘æ§è§†å›¾ (Monitoring)

**ä½ç½®**: `TaskMonitorView.vue` â†’ `EmbeddingMetricsPanel.vue`

**å®æ—¶æŒ‡æ ‡**:
- å½“å‰ RPM (Requests Per Minute)
- å¹¶å‘æ•° / é˜Ÿåˆ—é•¿åº¦
- Channel å¥åº·çŠ¶æ€ (é¥¼å›¾)
- æ–‡æ¡£å¤„ç†è¿›åº¦ (åˆ—è¡¨)

---

## ğŸ“¦ å…«ã€æ–‡ä»¶ç»“æ„

```
src/utility/embedding-engine/
â”œâ”€â”€ entry.ts                      # è¿›ç¨‹å…¥å£
â”œâ”€â”€ README.md                     # æ¶æ„æ–‡æ¡£ (æœ¬æ–‡ä»¶)
â”‚
â”œâ”€â”€ core/                         # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ task-manager.ts          # ä»»åŠ¡ç®¡ç†å™¨ (æ–‡æ¡£â†’Chunks ä¸¤çº§è¡¨)
â”‚   â”œâ”€â”€ scheduler.ts             # è°ƒåº¦å™¨ (å¹¶å‘æ§åˆ¶ + é˜Ÿåˆ—)
â”‚   â””â”€â”€ progress-tracker.ts      # è¿›åº¦è¿½è¸ª
â”‚
â”œâ”€â”€ channel/                      # é€šé“ç®¡ç†
â”‚   â”œâ”€â”€ channel-manager.ts       # å¤šæºçº§è” + ç†”æ–­
â”‚   â””â”€â”€ openai-client.ts         # OpenAI SDK å°è£…
â”‚
â”œâ”€â”€ bridge/                       # é€šä¿¡æ¡¥æ¥
â”‚   â””â”€â”€ task-monitor-bridge.ts  # ä¸å…¨å±€ç›‘æ§çš„ IPC æ¡¥æ¥
â”‚
â””â”€â”€ types.ts                      # å†…éƒ¨ç±»å‹å®šä¹‰
```

---

## ğŸš€ ä¹ã€å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„ (1-2å¤©)
- [x] ç›®å½•ç»“æ„åˆ›å»º
- [x] `entry.ts` ä¸ IPC æ¡æ‰‹
- [ ] `task-manager.ts` (ä¸¤çº§è¡¨)
- [ ] `scheduler.ts` (åŸºç¡€é˜Ÿåˆ—)

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (2-3å¤©)
- [ ] `channel-manager.ts` (å• channel)
- [ ] `openai-client.ts` (SDK å°è£…)
- [ ] `progress-tracker.ts`
- [ ] é›†æˆ TaskRegistry

### Phase 3: é«˜çº§ç‰¹æ€§ (2-3å¤©)
- [ ] å¤š channel çº§è”
- [ ] ç†”æ–­æœºåˆ¶
- [ ] å¹¶å‘åŠ¨æ€è°ƒèŠ‚
- [ ] IPC Handler (ä¸»è¿›ç¨‹)

### Phase 4: UI ä¸æµ‹è¯• (2å¤©)
- [ ] `EmbeddingConfigView.vue` (é…ç½®é¢æ¿)
- [ ] `EmbeddingMetricsPanel.vue` (ç›‘æ§é¢æ¿)
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸ” åã€å…³é”®æŠ€æœ¯å†³ç­–

### 10.1 ä¸ºä»€ä¹ˆä¸ç”¨ Worker Pool?
- **Worker Pool** é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ (å¦‚å›¾åƒå¤„ç†)
- **åµŒå…¥ä»»åŠ¡** æ˜¯ç½‘ç»œ I/O å¯†é›†å‹,å•çº¿ç¨‹ + async/await å³å¯å‹æ¦¨å¸¦å®½
- Utility Process æœ¬èº«å·²ç»éš”ç¦»,ä¸éœ€è¦é¢å¤–çº¿ç¨‹æ± 

### 10.2 ä¸ºä»€ä¹ˆä¸æ‰¹é‡æäº¤ Chunks?
- OpenAI SDK æ”¯æŒ `input: string[]`,ä½†å­˜åœ¨é—®é¢˜:
  - æŸäº› channel çš„æ‰¹é‡ API ä¸ç¨³å®š
  - æ‰¹é‡å¤±è´¥åæ— æ³•ç²¾ç¡®å®šä½å¤±è´¥çš„ chunk
- **å†³ç­–**: é€ä¸ªæäº¤,ä¿è¯ç²¾ç»†æ§åˆ¶

### 10.3 å¦‚ä½•å­˜å‚¨åµŒå…¥ç»“æœ?
- **æ–¹æ¡ˆ 1**: å®æ—¶å†™å…¥ SurrealDB (æ¯å®Œæˆä¸€ä¸ª chunk å°±å†™)
- **æ–¹æ¡ˆ 2**: å†…å­˜ç´¯ç§¯,æ–‡æ¡£å®Œæˆåæ‰¹é‡å†™å…¥
- **æ¨è**: æ–¹æ¡ˆ 2 + å¤±è´¥é‡è¯•æœºåˆ¶

---

## ğŸ“š åä¸€ã€å‚è€ƒèµ„æ–™

- [OpenAI Embeddings API](https://platform.openai.com/docs/guides/embeddings)
- [Electron Utility Process](https://www.electronjs.org/docs/latest/api/utility-process)
- [é¡¹ç›® Wiki - Document Processing Pipeline](#8)
- [é¡¹ç›® Wiki - Task Monitoring System](#7)

---

**è®¾è®¡å®Œæˆ,ç­‰å¾…å®¡æ ¸ä¸å®æ–½! ğŸ‰**
