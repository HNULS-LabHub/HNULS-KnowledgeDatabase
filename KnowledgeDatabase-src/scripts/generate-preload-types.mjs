import fs from 'fs/promises'
import path from 'path'
import { fileURLToPath } from 'url'

// --- helpers ---
const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// --- constants ---
const projectRoot = path.resolve(__dirname, '..')
const preloadDir = path.join(projectRoot, 'src', 'preload')
const typesDir = path.join(preloadDir, 'types')
const bridgeFile = path.join(preloadDir, 'bridge', 'index.ts')

const typesIndexFile = path.join(typesDir, 'index.ts')
const dtsFile = path.join(preloadDir, 'index.d.ts')

const AUTOGEN_HEADER = `/**
 * @file Automatically generated by scripts/generate-preload-types.mjs
 * Do not edit this file manually.
 */
`

/**
 * @description Generates `src/preload/types/index.ts` to export all types.
 */
async function generateTypesIndex() {
  try {
    const files = await fs.readdir(typesDir)
    const typeFiles = files.filter((f) => f.endsWith('.types.ts'))

    const exports = typeFiles
      .map((file) => `export * from './${file.replace('.ts', '')}'`)
      .join('\n')

    const content = `${AUTOGEN_HEADER}\n${exports}\n`
    await fs.writeFile(typesIndexFile, content, 'utf-8')
    console.log(`âœ… Successfully generated ${path.relative(projectRoot, typesIndexFile)}`)
  } catch (error) {
    console.error('Error generating types/index.ts:', error)
    process.exit(1)
  }
}

/**
 * @description Generates `src/preload/index.d.ts` based on the bridge.
 */
async function generateDtsFile() {
  try {
    const bridgeContent = await fs.readFile(bridgeFile, 'utf-8')

    // Use regex to find the keys in `customAPI` object.
    // This is simpler than a full AST parse and sufficient for this structure.
    const apiMatch = bridgeContent.match(/const customAPI = {([^}]+)}/)
    if (!apiMatch || !apiMatch[1]) {
      throw new Error('Could not find `customAPI` object in bridge file.')
    }

    const apiKeys = apiMatch[1]
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean)
      .map((key) => key.split(':')[0].trim()) // Handles cases like `test: testAPI`

    const apiInterfaces = apiKeys
      .map((key) => {
        // Convert snake-case/kebab-case to PascalCase for the type name
        const typeName = key.replace(/[-_](\w)/g, (_, c) => c.toUpperCase())
        const pascalCaseName = typeName.charAt(0).toUpperCase() + typeName.slice(1) + 'API'
        return `      ${key}: ${pascalCaseName}`
      })
      .join('\n')

    const typeImports = apiKeys
      .map((key) => {
        const typeName = key.replace(/[-_](\w)/g, (_, c) => c.toUpperCase())
        return typeName.charAt(0).toUpperCase() + typeName.slice(1) + 'API'
      })
      .join(', ')

    const dtsContent = `${AUTOGEN_HEADER}
import { ElectronAPI } from '@electron-toolkit/preload'
import type { ${typeImports} } from './types'

declare global {
  interface Window {
    electron: ElectronAPI
    api: {
${apiInterfaces}
    }
  }
}

export {}
`

    await fs.writeFile(dtsFile, dtsContent, 'utf-8')
    console.log(`âœ… Successfully generated ${path.relative(projectRoot, dtsFile)}`)
  } catch (error) {
    console.error('Error generating index.d.ts:', error)
    process.exit(1)
  }
}

async function main() {
  console.log('ðŸš€ Starting preload type generation...')
  await generateTypesIndex()
  await generateDtsFile()
  console.log('ðŸŽ‰ Preload type generation finished.')
}

main()
